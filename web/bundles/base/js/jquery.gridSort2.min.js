/*
	GridSort | 2013-2015
	Versï¿½o 2.0 - Maio 2015

	Defaults options:[
		totalItens: 0,
		itensPerPage: 0,
		sorters: [],
		pathAjax: "",
		paginacao: "",
		formulario: "",
		loadingStart: true,
		order: "ASC",
		class: "gridsort",
		all: false,
		searchChange:false
	]
*/
$(function(){$.widget("custom.gridSort",{gridN:0,options:{totalItens:0,itensPerPage:0,sorters:[],pathAjax:"",paginacao:"",formulario:"",loadingStart:!0,order:"ASC","class":"gridsort",all:!1,searchChange:!1,complete:!1,searchStart:!1},_create:function(){this.element.addClass(this.options["class"]),this.addPesquisa()},_destroy:function(){$(this.options.paginacao).find(".first, .prev, .next, .last").button("destroy"),$(this.options.paginacao).find(".views").buttonset("destroy"),$(this.options.paginacao).empty(),$(this.options.paginacao).removeClass("paginacao"),this.element.removeClass(this.element["class"]),this.element.find("thead").removeClass("ui-widget-header"),this.element.find("thead > tr").removeClass("ui-widget-header"),$(this.options.paginacao).removeClass("ui-widget-header ui-corner-all"),this.element.find("thead > tr th").find(".ui-icon").remove(),this.element.find("tbody").empty()},addPesquisa:function(){var i=this.options,e=this.element,a=this,t=$(this.options.paginacao);t.addClass("paginacao");var n,s,r,o=$('<span class="views" numero="'+this.gridN+'">');if(this.gridN=$(".views").length,this.gridN>0&&(this.gridN=parseInt($(".views:last").attr("numero"))+1),o.append('<input type="hidden" class="paginas" value="'+Math.floor(i.totalItens/i.itensPerPage)+'" />'),o.append('<input type="hidden" class="sort" value="'+(i.sorters.length>0?i.sorters[1][0]:"0")+'" />'),o.append('<input type="hidden" class="order" value="'+i.order+'" />'),o.append('<input type="hidden" class="current" value="0" />'),o.append('<input type="hidden" class="total" value="'+i.totalItens+'" />'),n='<input type="radio" name="view['+this.gridN+']" id="view20['+this.gridN+']" value="20"/><label for="view20['+this.gridN+']">20</label>',s='<input type="radio" name="view['+this.gridN+']" id="view50['+this.gridN+']" value="50"/><label for="view50['+this.gridN+']">50</label>',r='<input type="radio" name="view['+this.gridN+']" id="view100['+this.gridN+']" value="100"/><label for="view100['+this.gridN+']">100</label>',o.append(n).append(s).append(r),t.append(o),t.find('input[value="'+i.itensPerPage+'"]').attr("checked",!0),i.all===!0){var l;l='<input type="radio" name="view['+this.gridN+']" id="viewall['+this.gridN+']" class="all" value="'+i.totalItens+'" /><label for="viewall['+this.gridN+']">Todos</label>',o.append(l)}e.css({marginTop:"10px"}),e.children("thead").first().children("tr").first().addClass("ui-widget-header");var d=e.children("thead").first().children("tr").first().children("th"),p=null;$.each(d,function(e,a){if(p=$.inArray(e,i.sorters[0]),p>=0){var t=$(a),n=t.html();t.empty(),0==e&&"ASC"==i.order?t.append('<span campo="'+i.sorters[1][p]+'" class="ui-icon ui-icon-triangle-1-s"></span>'+n):0==e&&"DESC"==i.order?t.append('<span campo="'+i.sorters[1][p]+'" class="ui-icon ui-icon-triangle-1-n"></span>'+n):t.append('<span campo="'+i.sorters[1][p]+'" class="ui-icon ui-icon-triangle-1-s"></span>'+n)}}),t.addClass("ui-widget-header ui-corner-all"),t.append('<button class="first">First</button>'),t.append('<button class="prev">Prev</button>'),t.append('<input type="text" name="pag" class="pag" readonly="readonly" value="1 a '+e.children("tbody").first().children("tr").size()+" de ("+i.totalItens+')" />'),t.append('<button class="next">Next</button>'),t.append('<button class="last">Last</button>'),t.append(o),t.find(".first").button({text:!1,icons:{primary:"ui-icon-seek-start"}}).click(function(){t.find(".current").val("0"),a.pesquisar()}),t.find(".prev").button({text:!1,icons:{primary:"ui-icon-seek-prev"}}).click(function(){var i=t.find(".current").val();0==i?i=t.find(".paginas").val():(i--,t.find(".current").val(i)),a.pesquisar()}),t.find(".next").button({text:!1,icons:{primary:"ui-icon-seek-next"}}).click(function(){var i=t.find(".current").val();i==t.find(".paginas").val()?i=0:(i++,t.find(".current").val(i)),a.pesquisar()}),t.find(".last").button({text:!1,icons:{primary:"ui-icon-seek-end"}}).click(function(){t.find(".current").val(t.find(".paginas").val()),a.pesquisar()}),t.find(".views").buttonset(),e.find("th > span.ui-icon").click(function(){var i=$(this);i.hasClass("ui-icon-triangle-1-s")?(i.removeClass("ui-icon-triangle-1-s").addClass("ui-icon-triangle-1-n"),t.find(".order").val("DESC")):(i.removeClass("ui-icon-triangle-1-n").addClass("ui-icon-triangle-1-s"),t.find(".order").val("ASC")),t.find(".sort").val(i.attr("campo")),a.pesquisar()}),t.find("input[name='view["+this.gridN+"]']").click(function(i){if(t.find(".total").val()==$(this).val())t.find(".paginas").val("0"),t.find(".current").val("0");else{var e=Math.floor(t.find(".total").val()/$(this).val());e<t.find(".current").val()&&t.find(".current").val(e),t.find(".paginas").val(e)}a.pesquisar()}),this.options.searchChange===!0&&this.options.formulario&&(a=this,$(this.options.formulario).on("change",function(){a.pesquisar()})),1==this.options.searchStart&&this.pesquisar()},pesquisar:function(){var i=this.options,e=this.element,a=$(this.options.paginacao),t=this.gridN,n=[];i.formulario?(n=$(i.formulario).serializeArray(),n.push({name:"offset",value:a.find(".current").val()}),n.push({name:"limit",value:a.find("input[name='view["+this.gridN+"]']:checked").first().val()}),n.push({name:"sort",value:a.find(".sort").val()}),n.push({name:"order",value:a.find(".order").val()})):(n.push({name:"offset",value:a.find(".current").val()}),n.push({name:"limit",value:a.find("input[name='view["+this.gridN+"]']:checked").first().val()}),n.push({name:"sort",value:a.find(".sort").val()}),n.push({name:"order",value:a.find(".order").val()}));var s=e.children("tbody:first");if(s instanceof Object&&i.loadingStart){s.length/s.children("tr").length;$(".overlayGridsort").size()<1&&$("body").append('<div class="ui-widget-overlay overlayGridsort" style="width: 100%; height: 100%; z-index: 9998;"><img src="/template/inc/img/load_home.gif" /><span>Aguarde...</span></div>')}else s.html('<tr><td colspan="20"><div style="margin: auto; width: 20px"><img src="/template/inc/img/load_home.gif" width="20"></div></td></tr>');$.post(i.pathAjax,n,function(i){var n=e.children("tbody").first();n.empty(),i.linha.length<1?n.append('<tr class="error"><td class="error center" colspan="20">Nenhum Resultado Encontrado</td></tr>'):$.each(i.linha,function(i,e){n.append(e)});var s=a.find(".current").val()*a.find("input[name='view["+t+"]']:checked").val(),r=parseInt(i.quantidade),o=parseInt(a.find("input[name='view["+t+"]']:checked").val());a.find(".total").val(r),a.find(".paginas").val(Math.floor(r/o)),a.find(".all").val(r),a.find(".pag").val(s+1+" a "+(s+i.total)+" de ("+a.find(".total").val()+")"),i.quantidade||a.find(".pag").val(s+1+" a "+(s+i.total.length)+" de (1)"),i.total||a.find(".pag").val("1 a 1 de ("+i.quantidade+")")},"json").done(function(){$(".overlayGridsort").size()>=1&&$(".overlayGridsort").remove(),$.isFunction(i.complete)&&i.complete()}).error(function(){$(".overlayGridsort").size()>=1&&($(".overlayGridsort").remove(),s.html('<tr class="error"><td class="error center" colspan="20">Erro ao carregar dados. Email para: <strong><a href="mailto:coders@stech.net.br">coders@stech.net.br</a></strong></td></tr>'))})}})});